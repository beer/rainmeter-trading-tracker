[Rainmeter]
Update=1000
AccurateText=1
DynamicWindowSize=1
; 第一組選單：切換 Session 訊息
ContextTitle=Toggle Message
ContextAction=[!WriteKeyValue Variables SHOW_MSG "(1-#SHOW_MSG#)"][!Refresh]

; 第二組選單：切換時區資訊
ContextTitle2=Toggle Timezone Information
ContextAction2=[!WriteKeyValue Variables SHOW_UTC "(1-#SHOW_UTC#)"][!Refresh]

; 第三組選單：切換倒數數字顯示
ContextTitle3=Toggle Countdown Text
ContextAction3=[!WriteKeyValue Variables SHOW_COUNTDOWN "(1-#SHOW_COUNTDOWN#)"][!Refresh]

; 第四組選單：切換COUNTDOWN BAR
ContextTitle4=Toggle Countdown Bar
ContextAction4=[!WriteKeyValue Variables SHOW_COUNTDOWN_BAR "(1-#SHOW_COUNTDOWN_BAR#)"][!Refresh]

; 第五組選單：切換Macro BAR
ContextTitle5=Toggle Macro Bar
ContextAction5=[!WriteKeyValue Variables SHOW_MACRO_BAR "(1-#SHOW_MACRO_BAR#)"][!Refresh]


[Variables]
; 預設偏移值，會由 Lua 每秒自動更新
NYOffset=-5
; --- 在這裡調整透明度 (最後一個數字，建議 150-200) ---
ColorIdle=20,20,20,150
ColorAsia=80,80,80,150
ColorLondon=0,80,150,180
ColorNYOpen=0,120,60,180
ColorSilverBullet=255,180,0,200
ColorPMSession=120,0,150,180
ColorWhite=255,255,255,255

; Forex Factory 的 RSS 連結
URL=https://nfs.faireconomy.media/ff_calendar_thisweek.xml

; 預設一個初始顏色變數
CurrentSessionColor=#ColorIdle#

; --- 縮放參數 (1.0 為原大，0.8 縮小，1.2 放大) ---
Scale=2.8
; --- 基礎尺寸 (會隨 Scale 自動縮放) ---
; 原寬 240, 原高 110
BGWidth=(210 * #Scale#)
BGHeight=(70 * #Scale#)

; --- 顯示設定: 0=隱藏, 1=顯示 ---
SHOW_MSG=1
SHOW_UTC=1
SHOW_COUNTDOWN=1
SHOW_COUNTDOWN_BAR=1
SHOW_MACRO_BAR=1
HideCountdown=1
HideCountdownBar=1
HideMacro=1

; 新增這兩個計算變數，確保座標計算簡單化
OffsetWithLocal=(8 * #Scale#)
OffsetNoLocal=(2 * #Scale#)

Message="Initializing..."
MessageColor="255,255,255,200"
CountdownText=""
BarPercent=0
CurrentSessionColor="20,20,20,150"
SubSessionColor="0,0,0,0"
NextSessionColor="0,0,0,0"

; for macro
MacroLeft=0
MacroRight=0
MacroColor=255,255,255,220
; --- 基礎參數定義 ---
BarW=(#BGWidth# - (32 * #Scale#))
HalfW=((#BarW# / 2) - (2 * #Scale#))
MidX=(#BGWidth# / 2)

EventTitle=""

; --- 核心邏輯：Lua 與時間測量 ---

[MeasureLua]
Measure=Script
ScriptFile="#@#NYTime.lua"
;UpdateDivider=5

[MeasureNYTime]
Measure=Time
TimeZone=#NYOffset#
Format=%H:%M:%S
DynamicVariables=1

[MeasureNYHHMM]
Measure=Time
TimeZone=#NYOffset#
Format=%H%M
DynamicVariables=1

[MeasureLocalTime]
Measure=Time
; 這裡定義顯示格式：時:分:秒
Format=%H:%M:%S

; --- Session 邏輯判定 ---
[MeasureSessionCalc]
Measure=Calc
Formula=MeasureNYHHMM

; --- 介面渲染部分 (終極修正版) ---

[MeterBG]
Meter=Shape
; 增加 Stroke (邊框)，寬度設為 2.5 * Scale
Shape=Rectangle 0,0,#BGWidth#,#BGHeight#,(12 * #Scale#) | Fill Color #CurrentSessionColor# | StrokeWidth (0.8 * #Scale#) | Stroke Color #SubSessionColor#
DynamicVariables=1
MouseScrollUpAction=[!SetVariable Scale "(#Scale# + 0.1)"][!WriteKeyValue Variables Scale "(#Scale# + 0.1)"][!Refresh]
MouseScrollDownAction=[!SetVariable Scale "(#Scale# - 0.1)"][!WriteKeyValue Variables Scale "(#Scale# - 0.1)"][!Refresh]

[MeterMacroBar]
Meter=Shape

; --- 底層軌道 ---
Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)-(20 * #Scale#)),((#BGWidth# - (32 * #Scale#)) / 2),(1.5 * #Scale#),0.5 | Fill Color 255,255,255,60 | StrokeWidth 0
Shape2=Rectangle (16 * #Scale# + ((#BGWidth# - (32 * #Scale#)) / 2)),((#BGHeight# / 2)-(20 * #Scale#)),((#BGWidth# - (32 * #Scale#)) / 2),(1.5 * #Scale#),0.5 | Fill Color 255,255,255,60 | StrokeWidth 0
;Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)-(20 * #Scale#)),#HalfW#,(1.5 * #Scale#),0.5 | Fill Color 255,255,255,40 | StrokeWidth 0
;Shape2=Rectangle (#MidX# + (2 * #Scale#)),((#BGHeight# / 2)-(20 * #Scale#)),#HalfW#,(1.5 * #Scale#),0.5 | Fill Color 255,255,255,40 | StrokeWidth 0
; --- 動態進度條 ---

; 【後 15 分：由左向右縮減】
; 原理：固定在右側端點，透過 X 座標隨百分比向左位移來達成「向左生長」
Shape3=Rectangle (((#MidX# + (2 * #Scale#)) + #HalfW#) - (#HalfW# * #MacroRight#)),((#BGHeight# / 2)-(20 * #Scale#)),(#HalfW# * #MacroRight#),(1.5 * #Scale#),0.5 | Fill Color #MacroColor# | StrokeWidth 0
DynamicVariables=1

; 【前 15 分：由左向右縮減】
; 原理：透過增加 X 座標，讓條狀的左端點往右跑
Shape4=Rectangle ((16 * #Scale#) + (#HalfW# * (1 - #MacroLeft#))),((#BGHeight# / 2)-(20 * #Scale#)),(#HalfW# * #MacroLeft#),(1.5 * #Scale#),0.5 | Fill Color #MacroColor# | StrokeWidth 0
Hidden=#HideMacro#



[MeterNYClock]
Meter=String
MeasureName=MeasureNYTime
Text=%1
X=(#BGWidth# / 2)
; 核心修正：直接強制定位在背景 50% 的位置，不論 SHOW_MSG 是多少
; 這確保它永遠不會往上彈去撞標題
;Y=(#BGHeight# / 30)
Y=(2.6 * #Scale#)
StringAlign=Center
FontFace=roboto-regular
FontSize=(34 * #Scale#)
StringStyle=Bold
FontColor=255,255,255,255
AntiAlias=1
DynamicVariables=1
CharacterSpacing=1

[MeterCountdown]
Meter=Shape
; --- 底層軌道 ---
Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(20 * #Scale#)),(#BGWidth# - (32 * #Scale#)),(1.5 * #Scale#),0.5 | Fill Color 255,255,255,60 | StrokeWidth 0

; --- 頂層進度 (向右靠) ---
; 使用 [MeterCountdown:ContextVar] 來引用上面算好的數值
Shape2=Rectangle ((16 * #Scale#) + ((#BGWidth# - (32 * #Scale#)) * (1 - #BarPercent#))),((#BGHeight# / 2)+(20 * #Scale#)),((#BGWidth# - (32 * #Scale#)) * #BarPercent#),(1.5 * #Scale#),0.5 | Fill Color #NextSessionColor# | StrokeWidth 0

; 使用 DynamicVariables=1 確保 BarPercent 的變化能即時反應
;Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(18 * #Scale#)),((#BGWidth# - (32 * #Scale#)) * #BarPercent#),(1 * #Scale#),0.5 | Fill Color #ColorWhite# | StrokeWidth 0
;Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(18 * #Scale#)),(#ContextVar# * #BarPercent#),(1.5 * #Scale#),0.5 | Fill Color #NextSessionColor# | StrokeWidth 0
Hidden=#HideCountdownBar#
DynamicVariables=1



[MeterMessage]
Meter=String
Text=#Message#
;Text=#MacroLeft# #HideMacro# #Scale#
;Text="((16 * #Scale#) + ((#BGWidth# - (32 * #Scale#)) * (1 - #BarPercent#)))"
X=(16 * #Scale#)
; 頂部標題：死守在頂部 15% 的位置
Y=(55 * #Scale#)
FontFace=roboto-regular
FontSize=(6 * #Scale#)
; 顏色由 Lua 傳回的 resFont 決定
FontColor=#MessageColor#
AntiAlias=1
Hidden=(1 - #SHOW_MSG#)
DynamicVariables=1

[MeterCountdownTime]
Meter=String
Text=#CountdownText#
; 將時間定位在進度條上方右側
X=(#BGWidth# - (16 * #Scale#))
Y=(55 * #Scale#)
StringAlign=Right
FontFace=roboto-regular
FontSize=(6 * #Scale#)
FontColor=#NextSessionColor#
AntiAlias=1
; 只有當有倒數文字時才顯示
Hidden=#HideCountdown#

DynamicVariables=1

[MeterDSTNote]
Meter=String
Text=UTC#NYOffset#
X=(#BGWidth# - (16 * #Scale#))
Y=(7 * #Scale#)
StringAlign=Right
FontFace=roboto-regular
FontSize=(5 * #Scale#)
FontColor=255,255,255,50
AntiAlias=1
Hidden=(1 - #SHOW_UTC#)
DynamicVariables=1
