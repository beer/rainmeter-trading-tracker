[Rainmeter]
Update=1000
AccurateText=1
DynamicWindowSize=1

; --- Context Menu Settings / 右鍵選單設定 ---
; Toggle Session message display / 切換 Session 訊息顯示
ContextTitle=Toggle Message
ContextAction=[!WriteKeyValue Variables SHOW_MSG "(1-#SHOW_MSG#)"][!Refresh]

; Toggle Timezone offset display / 切換時區偏移資訊顯示
ContextTitle2=Toggle Timezone Information
ContextAction2=[!WriteKeyValue Variables SHOW_UTC "(1-#SHOW_UTC#)"][!Refresh]

; Toggle Countdown text display / 切換倒數時間文字顯示
ContextTitle3=Toggle Countdown Text
ContextAction3=[!WriteKeyValue Variables SHOW_COUNTDOWN "(1-#SHOW_COUNTDOWN#)"][!Refresh]

; Toggle Countdown progress bar / 切換倒數進度條顯示
ContextTitle4=Toggle Countdown Bar
ContextAction4=[!WriteKeyValue Variables SHOW_COUNTDOWN_BAR "(1-#SHOW_COUNTDOWN_BAR#)"][!Refresh]

; Toggle Macro progress bar / 切換 Macro 進度條顯示
ContextTitle5=Toggle Macro Bar
ContextAction5=[!WriteKeyValue Variables SHOW_MACRO_BAR "(1-#SHOW_MACRO_BAR#)"][!Refresh]

; Toggle News panel expansion / 切換新聞面板展開狀態
ContextTitle6=Toggle News
ContextAction6=[!WriteKeyValue Variables SHOW_NEWS "(1-#SHOW_NEWS#)"][!Refresh]

; Toggle Current Date display / 切換當前日期顯示
ContextTitle7=Toggle Date
ContextAction7=[!WriteKeyValue Variables SHOW_DATE "(1-#SHOW_DATE#)"][!Refresh]


[Variables]
; NYOffset is dynamically updated by Lua every second / 紐約偏移值由 Lua 每秒更新
NYOffset=-5

; --- Color & Alpha Settings / 顏色與透明度設定 ---
ColorIdle=20,20,20,150
ColorAsia=80,80,80,150
ColorLondon=0,80,150,180
ColorNYOpen=0,120,60,180
ColorSilverBullet=255,180,0,200
ColorPMSession=120,0,150,180
ColorWhite=255,255,255,255
ColorLightWhite=255,255,255,200
ColorExtraLightWhite=255,255,255,100

; Notification duration in seconds / 通知顯示時長(秒)
NOTIFY_DURATION=5

; RSS Feed URL for Forex Factory / 財經日曆 RSS 連結
URL=https://nfs.faireconomy.media/ff_calendar_thisweek.xml

; Initial background color / 初始背景顏色變數
CurrentSessionColor=#ColorIdle#

; --- Scaling Parameters / 縮放參數 ---
Scale=3.6
BGWidth=(210 * #Scale#)
BGHeight=(70 * #Scale#)

; --- Display Toggles (0=Hidden, 1=Shown) / 顯示切換開關 ---
SHOW_MSG=1
SHOW_UTC=1
SHOW_DATE=1
SHOW_COUNTDOWN=1
SHOW_COUNTDOWN_BAR=1
SHOW_MACRO_BAR=1
SHOW_NEWS=0

; State variables controlled by Lua / 由 Lua 腳本控制的狀態變數
HideCountdown=1
HideCountdownBar=1
HideMacro=1
HideNewsToggleButton=0
AutoHideNews=1

; Calculation offsets / 座標計算位移
OffsetWithLocal=(8 * #Scale#)
OffsetNoLocal=(2 * #Scale#)

; Dynamic display strings / 動態顯示字串
Message=""
MessageColor="255,255,255,150"
IconColor="255,255,255,50"
CountdownText=""
BarPercent=0
CurrentSessionColor="20,20,20,150"
SubSessionColor="0,0,0,0"
NextSessionColor="0,0,0,0"

; Macro animation variables / Macro 動畫變數
MacroLeft=0
MacroRight=0
MacroColor=255,255,255,220

; UI Layout parameters / 介面佈局參數
BarW=(#BGWidth# - (32 * #Scale#))
HalfW=((#BarW# / 2) - (2 * #Scale#))
MidX=(#BGWidth# / 2)

; News variables / 新聞相關變數
EventTitle="Checking News..."
EventCountry="--"
EventImpact="Low"
EventNYTime=""
EventDisplay=""
IsNewsFlash=0
FlashColor="255,0,0,200"
CountdownColor="255,0,0,150"
NewsBGColor=20,20,20,30

; ============================================================================
; CORE LOGIC: Measures / 核心邏輯：測量器
; ============================================================================

[MeasureLua]
Measure=Script
ScriptFile="#@#NYTime.lua"

[MeasureNYTime]
Measure=Time
TimeZone=#NYOffset#
Format=%H:%M:%S
DynamicVariables=1

[MeasureNYHHMM]
Measure=Time
TimeZone=#NYOffset#
Format=%H%M
DynamicVariables=1

[MeasureLocalTime]
Measure=Time
Format=%H:%M:%S

[MeasureSessionCalc]
Measure=Calc
Formula=MeasureNYHHMM

[MeasureFlashAnim]
Measure=Calc
; Controls blink speed (mod 2) / 控制閃爍速度
Formula=(MeasureFlashAnim + 1) % 2
UpdateDivider=1
; Blinking pauses if IsNewsFlash is 0 / 若無新聞閃爍則暫停動畫
Paused=(#IsNewsFlash# = 0 ? 1 : 0)
DynamicVariables=1

; ============================================================================
; METERS: Interface Rendering / 介面渲染
; ============================================================================

[MeterBG]
Meter=Shape
; 1. Main Background Rectangle / 主背景矩形
Shape=Rectangle 0,0,#BGWidth#,#BGHeight#,(12 * #Scale#) | Fill Color #CurrentSessionColor# | StrokeWidth (0.8 * #Scale#) | Stroke Color #SubSessionColor#
; 2. Warning Flash Layer (Red) / 警告閃爍層 (紅色)
Shape2=Rectangle 0,0,#BGWidth#,#BGHeight#,(12 * #Scale#) | Fill Color 255,0,0,(#IsNewsFlash# * [MeasureFlashAnim] * 150) | StrokeWidth 0
DynamicVariables=1
; Scaling with mouse wheel / 透過滾輪調整縮放比例
MouseScrollUpAction=[!SetVariable Scale "(#Scale# + 0.1)"][!WriteKeyValue Variables Scale "(#Scale# + 0.1)"][!Refresh]
MouseScrollDownAction=[!SetVariable Scale "(#Scale# - 0.1)"][!WriteKeyValue Variables Scale "(#Scale# - 0.1)"][!Refresh]


[MeterMacroBar]
Meter=Shape
; Track Background / 底層軌道
Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)-(35 * #Scale#)),((#BGWidth# - (32 * #Scale#)) / 2),(4 * #Scale#),0.5 | Fill Color 255,255,255,(1-[MeasureFlashAnim])*60 | StrokeWidth 0
Shape2=Rectangle (16 * #Scale# + ((#BGWidth# - (32 * #Scale#)) / 2)),((#BGHeight# / 2)-(35 * #Scale#)),((#BGWidth# - (32 * #Scale#)) / 2),(4 * #Scale#),0.5 | Fill Color 255,255,255,(1-[MeasureFlashAnim])*60 | StrokeWidth 0
; Macro Progress Bars (Left & Right animation) / Macro 進度條 (左右雙向動畫)
Shape3=Rectangle (((#MidX# + (2 * #Scale#)) + #HalfW#) - (#HalfW# * #MacroRight#)),((#BGHeight# / 2)-(35 * #Scale#)),(#HalfW# * #MacroRight#),(4 * #Scale#),0.5 | Fill Color #MacroColor# | StrokeWidth 0
Shape4=Rectangle ((16 * #Scale#) + (#HalfW# * (1 - #MacroLeft#))),((#BGHeight# / 2)-(35 * #Scale#)),(#HalfW# * #MacroLeft#),(4 * #Scale#),0.5 | Fill Color #MacroColor# | StrokeWidth 0
Hidden=#HideMacro#
DynamicVariables=1


[MeterNYClock]
Meter=String
MeasureName=MeasureNYTime
Text=%1
X=(#BGWidth# / 2)
Y=(2.6 * #Scale#)
StringAlign=Center
FontFace=roboto-regular
FontSize=(34 * #Scale#)
StringStyle=Bold
FontColor=255,255,255,255
AntiAlias=1
DynamicVariables=1
CharacterSpacing=1


[MeterCountdown]
Meter=Shape
; Bottom Track / 底層軌道
Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(31 * #Scale#)),(#BGWidth# - (32 * #Scale#)),(4 * #Scale#),0.5 | Fill Color 255,255,255,(1-[MeasureFlashAnim])*60 | StrokeWidth 0
; Progress Fill (Right-aligned) / 頂層進度 (向右靠)
Shape2=Rectangle ((16 * #Scale#) + ((#BGWidth# - (32 * #Scale#)) * (1 - #BarPercent#))),((#BGHeight# / 2)+(31 * #Scale#)),((#BGWidth# - (32 * #Scale#)) * #BarPercent#),(4 * #Scale#),0.5 | Fill Color #NextSessionColor# | StrokeWidth 0
Hidden=#HideCountdownBar#
DynamicVariables=1


[MeterMessage]
Meter=String
Text=#Message#
X=(16 * #Scale#)
Y=(55 * #Scale#)
FontFace=roboto-regular
FontSize=(6 * #Scale#)
FontColor=#MessageColor#
AntiAlias=1
Hidden=(1 - #SHOW_MSG#)
DynamicVariables=1


[MeterCountdownTime]
Meter=String
Text=#CountdownText#
X=(#BGWidth# - (16 * #Scale#))
Y=(55 * #Scale#)
StringAlign=Right
FontFace=roboto-regular
FontSize=(6 * #Scale#)
FontColor=#CountdownColor#
AntiAlias=1
Hidden=#HideCountdown#
DynamicVariables=1


[MeterDate]
Meter=String
Text=#CurrentDate#
X=(16 * #Scale#)
Y=(7 * #Scale#)
StringAlign=Left
FontFace=roboto-regular
FontSize=(5 * #Scale#)
FontColor=255,255,255,100
AntiAlias=1
Hidden=(1 - #SHOW_DATE#)
DynamicVariables=1


[MeterDSTNote]
Meter=String
Text=UTC#NYOffset#
X=(#BGWidth# - (16 * #Scale#))
Y=(7 * #Scale#)
StringAlign=Right
FontFace=roboto-regular
FontSize=(5 * #Scale#)
FontColor=255,255,255,100
AntiAlias=1
Hidden=(1 - #SHOW_UTC#)
DynamicVariables=1


[MeterNewsBG]
Meter=Shape
Group=NewsGroup
; Dynamic News Background linked to Text height / 動態新聞背景，隨文字高度變化
Shape=Rectangle 0, (74 * #Scale#), #BGWidth#, [MeterNews:H], (12 * #Scale#) | Fill Color #NewsBGColor# | StrokeWidth (0.8 * #Scale#) | Stroke Color #SubSessionColor#
DynamicVariables=1
MouseScrollUpAction=[!SetVariable Scale "(#Scale# + 0.1)"][!WriteKeyValue Variables Scale "(#Scale# + 0.1)"][!Refresh]
MouseScrollDownAction=[!SetVariable Scale "(#Scale# - 0.1)"][!WriteKeyValue Variables Scale "(#Scale# - 0.1)"][!Refresh]


[MeterNews]
Meter=String
Group=NewsGroup
Text="NEXT NEWS:#CRLF##EventDisplay#"
X=(16 * #Scale#)
Y=(76 * #Scale#)
W=(#BGWidth# - 32 * #Scale#)
ClipString=2
FontSize=(6 * #Scale#)
FontColor=#MessageColor#
FontFace=Segoe UI
AntiAlias=1
DynamicVariables=1
Padding=0, (1 * #Scale#), 0, (6 * #Scale#)


[MeasureJSONRaw]
Measure=WebParser
; Fetches weekly news calendar / 抓取本週新聞日曆
URL=https://nfs.faireconomy.media/ff_calendar_thisweek.json
RegExp=(?s)^(.*)$
Disabled=1
UpdateDivider=-1
; Executes Lua processing after download / 下載後執行 Lua 處理邏輯
FinishAction=[!CommandMeasure MeasureLua "OnDownloadComplete()"]


@Include=#@#MUI.inc

[MeasureIconToggle]
Measure=Calc
Formula=#SHOW_NEWS#
; Substitutes 1 with expand icon, 0 with menu icon / 將 1 換成開啟圖標，0 換成關閉圖標
RegExpSubstitute=1
Substitute="^1$":"#mui-menu-open#","^0$":"#mui-menu#"
DynamicVariables=1


[MeterMinimizeIcon]
Meter=String
MeasureName=MeasureIconToggle
Text=%1
X=(#BGWidth# - (6 * #Scale#))
Y=(57 * #Scale#)
FontFace=Material Icons
StringAlign=Right
FontSize=(6 * #Scale#)
FontColor=#IconColor#
DynamicVariables=1
; Hover effect settings / 懸停效果設定
MouseOverAction=[!SetOption #CURRENTSECTION# FontColor #ColorLightWhite#][!UpdateMeter #CURRENTSECTION#][!Redraw]
MouseLeaveAction=[!SetOption #CURRENTSECTION# FontColor #ColorExtraLightWhite#][!UpdateMeter #CURRENTSECTION#][!Redraw]
Hidden=#HideNewsToggleButton#
; Toggle action: switch variable and manually update Lua / 點擊動作：切換變數並強制 Lua 更新
LeftMouseUpAction=[!SetVariable SHOW_NEWS (1-#SHOW_NEWS#)][!WriteKeyValue Variables SHOW_NEWS "(1-#SHOW_NEWS#)"][!UpdateMeter MeterNews][!UpdateMeter MeterNewsBG][!CommandMeasure MeasureLua "Update()"]
