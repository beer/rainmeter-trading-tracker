[Rainmeter]
Update=1000
AccurateText=1
DynamicWindowSize=1
; 第一組選單：切換 Session 訊息
ContextTitle=Toggle Message
ContextAction=[!WriteKeyValue Variables SHOW_MSG "(1-#SHOW_MSG#)"][!Refresh]

; 第二組選單：切換時區資訊
ContextTitle2=Toggle Timezone Information
ContextAction2=[!WriteKeyValue Variables SHOW_UTC "(1-#SHOW_UTC#)"][!Refresh]


[Variables]
; 預設偏移值，會由 Lua 每秒自動更新
NYOffset=-5
; --- 在這裡調整透明度 (最後一個數字，建議 150-200) ---
ColorIdle=20,20,20,150
ColorAsia=80,80,80,150
ColorLondon=0,80,150,180
ColorNYOpen=0,120,60,180
ColorSilverBullet=255,180,0,200
ColorPMSession=120,0,150,180
ColorWhite=255,255,255,255

; Forex Factory 的 RSS 連結
URL=https://nfs.faireconomy.media/ff_calendar_thisweek.xml

; 預設一個初始顏色變數
CurrentSessionColor=#ColorIdle#

; --- 縮放參數 (1.0 為原大，0.8 縮小，1.2 放大) ---
Scale=3.6
; --- 基礎尺寸 (會隨 Scale 自動縮放) ---
; 原寬 240, 原高 110
BGWidth=(210 * #Scale#)
BGHeight=(70 * #Scale#)

; --- 顯示設定: 0=隱藏, 1=顯示 ---
SHOW_MSG=1
SHOW_UTC=0

; 新增這兩個計算變數，確保座標計算簡單化
OffsetWithLocal=(8 * #Scale#)
OffsetNoLocal=(2 * #Scale#)

BarPercent=0
NextSessionColor=0,0,0,0

; --- 核心邏輯：Lua 與時間測量 ---

[MeasureLua]
Measure=Script
ScriptFile="#@#NYTime.lua"

[MeasureNYTime]
Measure=Time
TimeZone=#NYOffset#
Format=%H:%M:%S
DynamicVariables=1

[MeasureNYHHMM]
Measure=Time
TimeZone=#NYOffset#
Format=%H%M
DynamicVariables=1

[MeasureLocalTime]
Measure=Time
; 這裡定義顯示格式：時:分:秒
Format=%H:%M:%S

; --- Session 邏輯判定 ---
[MeasureSessionCalc]
Measure=Calc
Formula=MeasureNYHHMM

; --- 介面渲染部分 (終極修正版) ---

[MeterBG]
Meter=Shape
; 確保背景足夠高 (120 * Scale)
Shape=Rectangle 0,0,#BGWidth#,#BGHeight#,(12 * #Scale#) | Fill Color #CurrentSessionColor# | StrokeWidth 0
DynamicVariables=1
MouseScrollUpAction=[!SetVariable Scale "(#Scale# + 0.1)"][!WriteKeyValue Variables Scale "(#Scale# + 0.1)"][!Refresh]
MouseScrollDownAction=[!SetVariable Scale "(#Scale# - 0.1)"][!WriteKeyValue Variables Scale "(#Scale# - 0.1)"][!Refresh]


[MeterNYClock]
Meter=String
MeasureName=MeasureNYTime
Text=%1
X=(#BGWidth# / 2)
; 核心修正：直接強制定位在背景 50% 的位置，不論 SHOW_MSG 是多少
; 這確保它永遠不會往上彈去撞標題
;Y=(#BGHeight# / 30)
Y=0
StringAlign=Center
FontFace=roboto-regular
FontSize=(34 * #Scale#)
StringStyle=Bold
FontColor=255,255,255,255
AntiAlias=1
DynamicVariables=1
CharacterSpacing=1

[MeterCountdown]
Meter=Shape
; 先定義一個變數來存放計算後的總寬度
ContextVar=(#BGWidth# - (32 * #Scale#))

; --- 底層軌道 ---
Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(18 * #Scale#)),(#BGWidth# - (32 * #Scale#)),(1.5 * #Scale#),0.5 | Fill Color 255,255,255,60 | StrokeWidth 0

; --- 頂層進度 (向右靠) ---
; 使用 [MeterCountdown:ContextVar] 來引用上面算好的數值
Shape2=Rectangle ((16 * #Scale#) + ((#BGWidth# - (32 * #Scale#)) * (1 - #BarPercent#))),((#BGHeight# / 2)+(18 * #Scale#)),((#BGWidth# - (32 * #Scale#)) * #BarPercent#),(1.5 * #Scale#),0.5 | Fill Color #NextSessionColor# | StrokeWidth 0

; 使用 DynamicVariables=1 確保 BarPercent 的變化能即時反應
;Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(18 * #Scale#)),((#BGWidth# - (32 * #Scale#)) * #BarPercent#),(1 * #Scale#),0.5 | Fill Color #ColorWhite# | StrokeWidth 0
;Shape=Rectangle (16 * #Scale#),((#BGHeight# / 2)+(18 * #Scale#)),(#ContextVar# * #BarPercent#),(1.5 * #Scale#),0.5 | Fill Color #NextSessionColor# | StrokeWidth 0
DynamicVariables=1
; 只有 BarPercent 大於 0 時才取消隱藏
Hidden=(#BarPercent# > 0 ? 0 : 1)

[MeterMessage]
Meter=String
Text=#Message#
;Text="((16 * #Scale#) + ((#BGWidth# - (32 * #Scale#)) * (1 - #BarPercent#)))"
X=(16 * #Scale#)
; 頂部標題：死守在頂部 15% 的位置
Y=(55 * #Scale#)
FontFace=roboto-regular
FontSize=(7 * #Scale#)
AntiAlias=1
Hidden=(1 - #SHOW_MSG#)
DynamicVariables=1

[MeterDSTNote]
Meter=String
Text=UTC#NYOffset#
X=(#BGWidth# - (16 * #Scale#))
Y=(55 * #Scale#)
StringAlign=Right
FontFace=roboto-regular
FontSize=(7 * #Scale#)
FontColor=255,255,255,50
AntiAlias=1
Hidden=(1 - #SHOW_UTC#)
DynamicVariables=1

